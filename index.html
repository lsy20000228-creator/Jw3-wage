<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>剑网三打工记账本</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: "Noto Sans SC", "Microsoft YaHei", sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        /* 动画 */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeInUp 0.4s ease-out forwards; }
        
        /* 玻璃拟态 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* 金币样式 */
        .currency-zhuan { color: #d97706; font-weight: 800; margin-right: 2px; font-family: 'DIN Alternate', sans-serif; }
        .currency-unit { font-size: 0.75em; color: #9ca3af; margin-right: 4px; font-weight: normal; }
        .font-din { font-family: 'DIN Alternate', 'Arial', sans-serif; }

        /* 交互类 */
        .hover-lift { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        
        .btn-account-active { 
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%); 
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
            border: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 门派配色表 (HEX) ---
        const SCHOOL_THEME = {
            "万花": "#a361a8", "七秀": "#fb7299", "少林": "#d8ae46", "纯阳": "#5aa0d9",
            "天策": "#df2e30", "藏剑": "#e8b646", "五毒": "#5c3b94", "唐门": "#006a92",
            "明教": "#d62c35", "丐帮": "#cd9a5b", "苍云": "#a66d2e", "长歌": "#66cdaa",
            "霸刀": "#7a6da8", "蓬莱": "#8ab0d6", "凌雪阁": "#a61c26", "衍天宗": "#9b7dbd",
            "北天药宗": "#008d76", "刀宗": "#6e8b98", "万灵山庄": "#a7c858", "段氏": "#7f8c8d",
            "default": "#94a3b8"
        };

        // --- 默认数据 (纯净版) ---
        const PRESET_ACCOUNTS = [];
        const PRESET_CHARS = [];

        const SCHOOLS = Object.keys(SCHOOL_THEME).filter(k => k !== 'default');
        const TARGET_RAIDS = ["25人普通弓月城", "25人英雄弓月城"];

        // --- 辅助函数 ---
        const getSchoolRGB = (schoolName) => {
            const hex = SCHOOL_THEME[schoolName] || SCHOOL_THEME['default'];
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return { r, g, b, hex };
        };

        const getSchoolStyle = (schoolName, opacity = 0.15) => {
            const { r, g, b, hex } = getSchoolRGB(schoolName);
            return {
                backgroundColor: `rgba(${r}, ${g}, ${b}, ${opacity})`,
                color: hex,
                borderColor: `rgba(${r}, ${g}, ${b}, 0.3)`,
                shadowColor: `rgba(${r}, ${g}, ${b}, 0.1)`
            };
        };

        const formatDate = (date) => {
            const m = date.getMonth() + 1;
            const d = date.getDate();
            return `${m < 10 ? '0' + m : m}月${d < 10 ? '0' + d : d}日`;
        };

        // --- 金币格式化组件 ---
        const MoneyDisplay = ({ amount, className = "" }) => {
            if (!amount && amount !== 0) return null;
            
            if (amount < 10000) {
                return <span className={`font-din ${className}`}>{amount}</span>;
            }

            const zhuan = Math.floor(amount / 10000);
            const jin = amount % 10000;

            return (
                <span className={className}>
                    <span className="currency-zhuan">{zhuan}</span>
                    <span className="currency-unit">砖</span>
                    {jin > 0 && <span className="font-din">{jin}</span>}
                </span>
            );
        };

        // --- 弹窗组件 ---
        const ModalWrapper = ({ children, onClose }) => (
            <div className="fixed inset-0 bg-slate-900/30 flex items-center justify-center z-50 backdrop-blur-sm transition-all" onClick={onClose}>
                <div className="bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl ring-1 ring-black/5 p-6 w-[420px] transform transition-all scale-100 animate-fade-in" onClick={e => e.stopPropagation()}>
                    {children}
                </div>
            </div>
        );

        // --- 组件: 数据备份弹窗 ---
        const DataBackupModal = ({ isOpen, onClose, data, onImport, onReset }) => {
            if (!isOpen) return null;
            const handleExport = () => {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `剑三工资账本备份_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            const handleImportFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.accounts && importedData.characters) {
                            if(confirm(`检测到备份文件。\n确定要覆盖当前数据吗？`)) {
                                onImport(importedData);
                                onClose();
                            }
                        } else { alert("文件格式不正确"); }
                    } catch (err) { alert("文件解析失败：" + err.message); }
                };
                reader.readAsText(file);
            };

            return (
                <ModalWrapper onClose={onClose}>
                    <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-3">
                        <h3 className="text-xl font-bold text-slate-800">数据备份与恢复</h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-2xl">×</button>
                    </div>
                    <div className="space-y-4">
                        <div className="p-5 bg-indigo-50/50 rounded-xl border border-indigo-100 hover:border-indigo-200 transition-colors">
                            <h4 className="font-bold text-indigo-800 mb-2 flex items-center gap-2">
                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                导出数据
                            </h4>
                            <p className="text-xs text-indigo-600/70 mb-4">将当前数据保存为本地文件。</p>
                            <button onClick={handleExport} className="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm shadow-lg shadow-indigo-200 transition-all active:scale-95">
                                下载备份 (.json)
                            </button>
                        </div>
                        <div className="p-5 bg-slate-50/50 rounded-xl border border-slate-200 hover:border-slate-300 transition-colors">
                            <h4 className="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                                导入数据
                            </h4>
                            <p className="text-xs text-slate-500 mb-4">上传备份文件以恢复数据。</p>
                            <label className="block w-full cursor-pointer group">
                                <span className="block w-full py-2.5 bg-white border border-slate-300 group-hover:border-indigo-500 text-slate-600 group-hover:text-indigo-600 rounded-lg font-bold text-sm text-center transition-all shadow-sm">
                                    选择文件恢复
                                </span>
                                <input type="file" className="hidden" accept=".json" onChange={handleImportFile} />
                            </label>
                        </div>
                        <div className="pt-2 border-t border-slate-100">
                            <button onClick={onReset} className="w-full py-2 text-red-400 hover:text-red-600 text-xs font-bold hover:bg-red-50 rounded-lg transition-colors">
                                清空所有数据 (重置)
                            </button>
                        </div>
                    </div>
                </ModalWrapper>
            );
        };

        // --- 组件: 记账弹窗 ---
        const WageModal = ({ isOpen, onClose, onConfirm, char, raidName, date }) => {
            const inputRef = useRef(null);
            const [wage, setWage] = useState('');
            useEffect(() => { if (isOpen) { setWage(''); setTimeout(() => inputRef.current?.focus(), 50); } }, [isOpen]);
            if (!isOpen) return null;

            return (
                <ModalWrapper onClose={onClose}>
                    <h3 className="text-xl font-bold text-slate-800 mb-1">记一笔工资</h3>
                    <p className="text-xs text-slate-400 mb-6">记录日期: {date}</p>
                    
                    <div className="flex items-center gap-4 mb-6 p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <div className="w-10 h-10 rounded-lg flex items-center justify-center text-lg font-bold text-white shadow-sm" style={{backgroundColor: getSchoolStyle(char?.school || 'default').color}}>
                            {char?.school?.[0]}
                        </div>
                        <div>
                            <div className="font-bold text-slate-800">{char?.name}</div>
                            <div className="text-xs text-slate-500">{char?.server} · {raidName}</div>
                        </div>
                    </div>

                    <div className="relative mb-2">
                        <span className="absolute left-4 top-3.5 text-slate-400 font-bold text-xl">¥</span>
                        <input 
                            ref={inputRef}
                            type="number" 
                            className="w-full pl-10 pr-4 py-3 text-2xl font-din font-bold border-2 border-slate-100 rounded-xl focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all"
                            placeholder="0"
                            value={wage}
                            onChange={e => setWage(e.target.value)}
                            onKeyDown={e => { if (e.key === 'Enter') onConfirm(wage); if (e.key === 'Escape') onClose(); }}
                        />
                    </div>
                    <div className="h-6 mb-6 text-right">
                        {wage >= 10000 && (
                            <span className="text-sm font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-md border border-orange-100 animate-pulse">
                                = <MoneyDisplay amount={parseInt(wage)} />
                            </span>
                        )}
                    </div>
                    <div className="flex gap-3">
                        <button onClick={onClose} className="flex-1 py-3 text-slate-500 hover:bg-slate-100 rounded-xl text-base font-bold transition-colors">取消</button>
                        <button onClick={() => onConfirm(wage)} className="flex-1 py-3 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-700 hover:to-violet-700 text-white rounded-xl text-base font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95">确认入账</button>
                    </div>
                </ModalWrapper>
            );
        };

        // --- 组件: 账号管理 ---
        const AccountManagerModal = ({ isOpen, onClose, accounts, onSaveAccounts }) => {
            const [localAccounts, setLocalAccounts] = useState([]);
            useEffect(() => { if (isOpen) setLocalAccounts(JSON.parse(JSON.stringify(accounts))); }, [isOpen, accounts]);
            const handleAdd = () => setLocalAccounts([...localAccounts, { id: Date.now().toString(), name: '新账号', password: '' }]);
            const handleChange = (id, field, value) => setLocalAccounts(localAccounts.map(acc => acc.id === id ? { ...acc, [field]: value } : acc));
            const handleDelete = (id) => { if (confirm('确定删除？')) setLocalAccounts(localAccounts.filter(acc => acc.id !== id)); };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/30 flex items-center justify-center z-50 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-[600px] max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4"><h3 className="text-xl font-bold text-slate-800">账号管理</h3><button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-2xl">×</button></div>
                        <div className="flex-1 overflow-y-auto space-y-3 p-1">
                            {localAccounts.length === 0 && <div className="text-center text-slate-400 py-8 text-sm">暂无账号，点击下方按钮添加</div>}
                            {localAccounts.map((acc, i) => (
                                <div key={acc.id} className="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100">
                                    <span className="text-slate-400 font-bold w-6 text-center">{i + 1}</span>
                                    <input className="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 outline-none focus:border-indigo-500" value={acc.name} onChange={e => handleChange(acc.id, 'name', e.target.value)} placeholder="账号" />
                                    <input className="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-mono text-slate-600 outline-none focus:border-indigo-500" value={acc.password} placeholder="密码 (选填)" onChange={e => handleChange(acc.id, 'password', e.target.value)} />
                                    <button onClick={() => handleDelete(acc.id)} className="text-red-400 hover:text-red-600 p-2"><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                </div>
                            ))}
                            <button onClick={handleAdd} className="w-full py-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-bold hover:border-indigo-500 hover:text-indigo-600 hover:bg-indigo-50 transition-all">添加新账号</button>
                        </div>
                        <div className="flex gap-3 mt-6"><button onClick={onClose} className="flex-1 py-3 text-slate-500 hover:bg-slate-100 rounded-xl font-bold">取消</button><button onClick={() => {onSaveAccounts(localAccounts); onClose();}} className="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900">保存</button></div>
                    </div>
                </div>
            );
        };

        // --- 组件: 角色编辑 (支持新建) ---
        const CharEditModal = ({ isOpen, onClose, onSave, char, accounts }) => {
            const [formData, setFormData] = useState({ name: '', server: '', school: '万花', score: '', accountId: '' });
            
            useEffect(() => { 
                if (isOpen) {
                    if (char) {
                        setFormData({ ...char, accountId: char.accountId || '' });
                    } else {
                        // 新建模式默认值
                        setFormData({ name: '', server: '绝代天骄', school: '万花', score: '', accountId: '' });
                    }
                }
            }, [isOpen, char]);

            if (!isOpen) return null;
            
            const isEdit = !!char;

            return (
                <ModalWrapper onClose={onClose}>
                    <div className="flex justify-between items-center mb-6 border-b pb-3">
                        <h3 className="text-xl font-bold text-slate-800">{isEdit ? '编辑角色' : '添加新角色'}</h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-2xl">×</button>
                    </div>
                    <div className="space-y-4">
                        <div><label className="text-xs font-bold text-slate-400 uppercase">归属账号</label><select className="w-full mt-1 border border-slate-200 rounded-lg p-2.5 text-sm font-bold text-slate-700 outline-none focus:border-indigo-500 bg-slate-50" value={formData.accountId} onChange={e => setFormData({...formData, accountId: e.target.value})}><option value="">-- 未绑定 --</option>{accounts.map(acc => <option key={acc.id} value={acc.id}>{acc.name}</option>)}</select></div>
                        <div><label className="text-xs font-bold text-slate-400 uppercase">角色名</label><input className="w-full mt-1 border border-slate-200 rounded-lg p-2.5 text-base outline-none focus:border-indigo-500" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} placeholder="例如: 瞎球球" /></div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-xs font-bold text-slate-400 uppercase">区服</label><input className="w-full mt-1 border border-slate-200 rounded-lg p-2.5 outline-none focus:border-indigo-500" value={formData.server} onChange={e => setFormData({...formData, server: e.target.value})} /></div>
                            <div><label className="text-xs font-bold text-slate-400 uppercase">门派</label><select className="w-full mt-1 border border-slate-200 rounded-lg p-2.5 outline-none focus:border-indigo-500 bg-white" value={formData.school} onChange={e => setFormData({...formData, school: e.target.value})}>{SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                        </div>
                        <div><label className="text-xs font-bold text-slate-400 uppercase">装分</label><input type="number" className="w-full mt-1 border border-slate-200 rounded-lg p-2.5 outline-none focus:border-indigo-500" value={formData.score} onChange={e => setFormData({...formData, score: parseInt(e.target.value) || 0})} placeholder="0" /></div>
                    </div>
                    <div className="flex gap-3 mt-6"><button onClick={onClose} className="flex-1 py-2.5 text-slate-500 hover:bg-slate-100 rounded-lg font-bold">取消</button><button onClick={() => onSave(formData)} className="flex-1 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">{isEdit ? '保存修改' : '立即添加'}</button></div>
                </ModalWrapper>
            );
        };

        const App = () => {
            // --- State ---
            const [accounts, setAccounts] = useState(PRESET_ACCOUNTS);
            const [characters, setCharacters] = useState(PRESET_CHARS);
            const [records, setRecords] = useState([]);
            const [lastSavedTime, setLastSavedTime] = useState(null);
            
            const [filterAccountId, setFilterAccountId] = useState('全部');
            const [searchTerm, setSearchTerm] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'score', direction: 'desc' });
            const [weekOffset, setWeekOffset] = useState(0);
            
            const [wageModal, setWageModal] = useState({ isOpen: false, charId: null, raidName: null });
            const [editModal, setEditModal] = useState({ isOpen: false, char: null }); // char为null表示新建
            const [accManagerModal, setAccManagerModal] = useState(false);
            const [backupModal, setBackupModal] = useState(false);

            // --- Load/Save ---
            useEffect(() => {
                const savedChars = localStorage.getItem('jx3_chars_v7_clean');
                const savedAccs = localStorage.getItem('jx3_accounts_v7_clean');
                const savedRecords = localStorage.getItem('jx3_records_v7_clean');
                if (savedChars) setCharacters(JSON.parse(savedChars));
                if (savedAccs) setAccounts(JSON.parse(savedAccs));
                if (savedRecords) setRecords(JSON.parse(savedRecords));
            }, []);

            useEffect(() => { 
                localStorage.setItem('jx3_chars_v7_clean', JSON.stringify(characters)); 
                localStorage.setItem('jx3_accounts_v7_clean', JSON.stringify(accounts)); 
                localStorage.setItem('jx3_records_v7_clean', JSON.stringify(records)); 
                const now = new Date();
                setLastSavedTime(`${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`);
            }, [characters, accounts, records]);

            // --- Logic ---
            const { weekStart, weekEnd, weekLabel } = useMemo(() => {
                const now = new Date();
                const currentDay = now.getDay();
                const diff = now.getDate() - currentDay + (currentDay === 0 ? -6 : 1); 
                const start = new Date(now);
                start.setDate(diff + (weekOffset * 7));
                start.setHours(0, 0, 0, 0);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
                return { weekStart: start, weekEnd: end, weekLabel: `${formatDate(start)} - ${formatDate(end)}` };
            }, [weekOffset]);

            const filteredCharacters = useMemo(() => {
                let chars = characters;
                if (filterAccountId !== '全部') chars = chars.filter(c => c.accountId === filterAccountId);
                if (searchTerm) chars = chars.filter(c => c.name.includes(searchTerm));
                return [...chars].sort((a, b) => {
                    let valA = a[sortConfig.key];
                    let valB = b[sortConfig.key];
                    if (sortConfig.key === 'account') {
                        valA = accounts.find(acc => acc.id === a.accountId)?.name || '';
                        valB = accounts.find(acc => acc.id === b.accountId)?.name || '';
                    }
                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }, [characters, filterAccountId, searchTerm, sortConfig, accounts]);

            const currentWeekRecords = useMemo(() => {
                return records.filter(r => {
                    const d = new Date(r.date);
                    return d >= weekStart && d <= weekEnd;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [records, weekStart, weekEnd]);

            const getRaidStatus = (charId, raidName) => currentWeekRecords.find(r => r.charId === charId && r.raidName === raidName);
            const weeklyIncome = currentWeekRecords.reduce((sum, r) => sum + r.wage, 0);

            const handleConfirmRecord = (wage) => {
                if (!wage) return;
                let recordDate = new Date();
                if (weekOffset !== 0) recordDate = new Date(weekStart);
                const newRecord = { id: Date.now().toString(), charId: wageModal.charId, raidName: wageModal.raidName, wage: parseInt(wage), date: recordDate.toISOString().split('T')[0] };
                setRecords([newRecord, ...records]);
                setWageModal({ ...wageModal, isOpen: false });
            };
            const handleDeleteRecord = (id) => { if(confirm("删除这条记录？")) setRecords(records.filter(r => r.id !== id)); };
            
            // 统一处理新建和编辑
            const handleSaveChar = (formData) => {
                if (formData.id) {
                    // 编辑
                    setCharacters(characters.map(c => c.id === formData.id ? formData : c));
                } else {
                    // 新建
                    const newChar = { ...formData, id: Date.now().toString() };
                    setCharacters([...characters, newChar]);
                }
                setEditModal({ isOpen: false, char: null });
            };

            const handleSaveAccounts = (newAccounts) => { setAccounts(newAccounts); const newIds = new Set(newAccounts.map(a => a.id)); setCharacters(characters.map(c => newIds.has(c.accountId) ? c : { ...c, accountId: '' })); };
            const handleSort = (key) => { let direction = 'desc'; if (sortConfig.key === key && sortConfig.direction === 'desc') direction = 'asc'; setSortConfig({ key, direction }); };
            const handleImportData = (data) => { setAccounts(data.accounts || []); setCharacters(data.characters || []); setRecords(data.records || []); alert("数据恢复成功！"); };
            
            const handleResetData = () => {
                if(confirm("确定要清空所有数据吗？\n此操作不可撤销！")) {
                    localStorage.removeItem('jx3_chars_v7_clean');
                    localStorage.removeItem('jx3_accounts_v7_clean');
                    localStorage.removeItem('jx3_records_v7_clean');
                    setAccounts([]);
                    setCharacters([]);
                    setRecords([]);
                    alert("数据已清空。");
                }
            };

            return (
                <div className="w-full h-screen flex flex-col text-slate-800 bg-transparent">
                    <WageModal isOpen={wageModal.isOpen} onClose={() => setWageModal({...wageModal, isOpen: false})} onConfirm={handleConfirmRecord} char={characters.find(c => c.id === wageModal.charId)} raidName={wageModal.raidName} date={weekOffset === 0 ? "今天" : formatDate(weekStart)} />
                    <CharEditModal isOpen={editModal.isOpen} onClose={() => setEditModal({...editModal, isOpen: false})} onSave={handleSaveChar} char={editModal.char} accounts={accounts} />
                    <AccountManagerModal isOpen={accManagerModal} onClose={() => setAccManagerModal(false)} accounts={accounts} onSaveAccounts={handleSaveAccounts} />
                    <DataBackupModal isOpen={backupModal} onClose={() => setBackupModal(false)} data={{accounts, characters, records}} onImport={handleImportData} onReset={handleResetData} />

                    {/* 顶部栏 */}
                    <header className="h-20 glass-header flex items-center justify-between px-8 shrink-0 z-20 sticky top-0">
                        <div className="flex items-center gap-5">
                            <div className="bg-gradient-to-br from-indigo-500 to-violet-600 text-white w-10 h-10 rounded-xl flex items-center justify-center font-bold text-2xl shadow-lg shadow-indigo-200">剑</div>
                            <div>
                                <div className="flex items-center gap-3">
                                    <h1 className="font-bold text-slate-800 text-xl leading-tight tracking-tight">工资小账本</h1>
                                    {lastSavedTime && (
                                        <span className="text-[10px] text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full flex items-center gap-1 border border-emerald-100">
                                            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>
                                            已保存 {lastSavedTime}
                                        </span>
                                    )}
                                </div>
                                <p className="text-sm text-slate-400 mt-0.5 font-medium">统计周期: {weekLabel}</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-6">
                            <button onClick={() => setBackupModal(true)} className="flex items-center gap-1.5 px-4 py-2 text-slate-500 hover:text-indigo-600 hover:bg-white rounded-lg transition-all font-bold text-sm">
                                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                                备份/恢复
                            </button>
                            <div className="bg-white/50 backdrop-blur-sm px-6 py-2 rounded-2xl border border-white/50 shadow-sm flex items-baseline gap-3">
                                <span className="text-xs text-slate-400 font-bold uppercase tracking-wider">{weekOffset === 0 ? '本周' : '该周'}收益</span>
                                <span className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-500 to-emerald-600 font-din">
                                    +<MoneyDisplay amount={weeklyIncome} />
                                </span>
                            </div>
                        </div>
                    </header>

                    <div className="flex-1 overflow-hidden flex p-4 gap-4">
                        {/* 左侧：列表 */}
                        <div className="flex-1 flex flex-col glass-panel rounded-3xl overflow-hidden shadow-sm">
                            {/* 工具栏 */}
                            <div className="px-6 py-4 border-b border-slate-100 flex items-center gap-4 bg-white/50">
                                <div className="flex gap-2 overflow-x-auto whitespace-nowrap scrollbar-hide flex-1 pr-4 items-center">
                                    <span className="text-xs font-bold text-slate-400 shrink-0 mr-2">账号筛选</span>
                                    <button onClick={() => setFilterAccountId('全部')} className={`px-4 py-1.5 rounded-full text-sm font-bold transition-all border shrink-0 ${filterAccountId === '全部' ? 'btn-account-active' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>全部</button>
                                    {accounts.map(acc => (<button key={acc.id} onClick={() => setFilterAccountId(acc.id)} className={`px-4 py-1.5 rounded-full text-sm font-bold transition-all border shrink-0 ${filterAccountId === acc.id ? 'btn-account-active' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>{acc.name}</button>))}
                                    <button onClick={() => setAccManagerModal(true)} className="ml-2 w-8 h-8 rounded-full bg-slate-100 hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 flex items-center justify-center transition-all" title="管理账号"><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button>
                                </div>
                                
                                <div className="flex items-center gap-3">
                                    <button onClick={() => setEditModal({ isOpen: true, char: null })} className="flex items-center gap-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95">
                                        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" /></svg>
                                        新增角色
                                    </button>
                                    <div className="relative w-48 shrink-0"><svg className="w-4 h-4 absolute left-3 top-2.5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg><input type="text" placeholder="搜索角色..." className="w-full pl-9 pr-4 py-2 text-sm bg-slate-100/50 border-none rounded-xl focus:ring-2 focus:ring-indigo-500/20 outline-none transition-all font-medium text-slate-600" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                </div>
                            </div>

                            {/* 表格 */}
                            <div className="flex-1 overflow-y-auto p-6 bg-white/30">
                                {filteredCharacters.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-full text-slate-400 pb-20">
                                        <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-6 shadow-sm">
                                            <svg className="w-10 h-10 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                                        </div>
                                        <h3 className="text-xl font-bold text-slate-700 mb-2">还没有角色哦</h3>
                                        <p className="text-slate-400 mb-8">添加你的第一个角色，开始记录打工收益吧！</p>
                                        <button onClick={() => setEditModal({ isOpen: true, char: null })} className="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-xl shadow-indigo-200 transition-all hover:scale-105 active:scale-95">
                                            立即添加角色
                                        </button>
                                    </div>
                                ) : (
                                    <div className="max-w-[1400px] mx-auto grid grid-cols-1 gap-3">
                                        <div className="grid grid-cols-12 gap-4 px-6 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider">
                                            <div className="col-span-1"></div>
                                            <div className="col-span-2 cursor-pointer hover:text-indigo-600" onClick={() => handleSort('name')}>角色名</div>
                                            <div className="col-span-2 cursor-pointer hover:text-indigo-600" onClick={() => handleSort('server')}>区服</div>
                                            <div className="col-span-1 cursor-pointer hover:text-indigo-600" onClick={() => handleSort('school')}>门派</div>
                                            <div className="col-span-1 cursor-pointer hover:text-indigo-600" onClick={() => handleSort('score')}>装分</div>
                                            <div className="col-span-2 cursor-pointer hover:text-indigo-600" onClick={() => handleSort('account')}>所属账号</div>
                                            {TARGET_RAIDS.map(raid => <div key={raid} className="col-span-1 text-center">{raid.replace('25人', '').replace('弓月城','')}</div>)}
                                            <div className="col-span-1 text-center">操作</div>
                                        </div>
                                        {filteredCharacters.map((char, idx) => {
                                            const accountName = accounts.find(a => a.id === char.accountId)?.name || '未绑定';
                                            const { r, g, b } = getSchoolRGB(char.school);
                                            const cardBg = `rgba(${r}, ${g}, ${b}, 0.04)`;
                                            const cardBorder = `rgba(${r}, ${g}, ${b}, 0.15)`;
                                            const schoolStyle = getSchoolStyle(char.school);
                                            
                                            return (
                                                <div 
                                                    key={char.id} 
                                                    className="grid grid-cols-12 gap-4 items-center rounded-2xl p-3 shadow-sm hover-lift border animate-fade-in" 
                                                    style={{
                                                        backgroundColor: cardBg,
                                                        borderColor: cardBorder,
                                                        animationDelay: `${idx * 0.05}s`
                                                    }}
                                                >
                                                    <div className="col-span-1 flex justify-center"><div className="w-12 h-12 rounded-xl flex items-center justify-center text-lg font-bold text-white shadow-md shrink-0" style={{backgroundColor: schoolStyle.color}}>{char.school[0]}</div></div>
                                                    <div className="col-span-2"><div className="font-bold text-slate-800 text-lg truncate" title={char.name}>{char.name}</div></div>
                                                    <div className="col-span-2"><span className="text-sm font-medium text-slate-500">{char.server}</span></div>
                                                    <div className="col-span-1"><span className="text-xs font-bold px-2.5 py-1 rounded-lg" style={{backgroundColor: schoolStyle.backgroundColor, color: schoolStyle.color}}>{char.school}</span></div>
                                                    <div className="col-span-1"><span className="text-sm font-din font-bold text-slate-600">{char.score}</span></div>
                                                    <div className="col-span-2"><div className="flex items-center gap-1.5"><span className="w-1.5 h-1.5 rounded-full bg-slate-300"></span><span className="text-sm text-slate-500 truncate" title={accountName}>{accountName}</span></div></div>
                                                    {TARGET_RAIDS.map(raid => {
                                                        const status = getRaidStatus(char.id, raid);
                                                        return (
                                                            <div key={raid} className="col-span-1 flex justify-center">
                                                                {status ? (
                                                                    <div className="flex flex-col items-center">
                                                                        <span className="bg-emerald-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md shadow-emerald-200">已打</span>
                                                                        <span className="text-[10px] text-emerald-600 mt-1 font-din font-bold">+<MoneyDisplay amount={status.wage} /></span>
                                                                    </div>
                                                                ) : (
                                                                    <button onClick={() => setWageModal({ isOpen: true, charId: char.id, raidName: raid })} className="w-full py-1.5 rounded-lg border-2 border-dashed border-slate-200 hover:border-indigo-400 hover:bg-indigo-50 transition-all flex items-center justify-center group/btn opacity-60 hover:opacity-100" title="点击记账"><span className="w-2 h-2 rounded-full bg-slate-300 group-hover/btn:bg-indigo-500 transition-colors"></span></button>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                    <div className="col-span-1 flex justify-center"><button onClick={() => setEditModal({ isOpen: true, char: char })} className="p-2 text-slate-300 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"><svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button></div>
                                                </div>
                                            );
                                        })}
                                        <div className="h-10"></div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 右侧：历史记录 */}
                        <div className="w-[360px] glass-panel rounded-3xl flex flex-col shrink-0 shadow-sm overflow-hidden">
                            <div className="px-5 py-4 border-b border-slate-100 bg-white/50">
                                <div className="flex items-center justify-between mb-3"><h3 className="font-bold text-slate-700 text-lg">账单流水</h3><span className="text-xs font-bold text-slate-400 bg-white px-2 py-1 rounded-md shadow-sm">共 {currentWeekRecords.length} 笔</span></div>
                                <div className="flex items-center justify-between bg-white rounded-xl p-1 shadow-sm border border-slate-100">
                                    <button onClick={() => setWeekOffset(weekOffset - 1)} className="p-2 hover:bg-slate-50 rounded-lg text-slate-400 hover:text-indigo-600 transition-all"><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg></button>
                                    <span className="text-sm font-bold text-slate-600 font-din">{weekLabel}</span>
                                    <button onClick={() => setWeekOffset(weekOffset + 1)} disabled={weekOffset === 0} className={`p-2 rounded-lg transition-all ${weekOffset === 0 ? 'text-slate-200 cursor-not-allowed' : 'hover:bg-slate-50 text-slate-400 hover:text-indigo-600'}`}><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" /></svg></button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/30">
                                {currentWeekRecords.length === 0 ? (
                                    <div className="flex flex-col items-center justify-center h-64 text-slate-400"><div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3"><svg className="w-8 h-8 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><p className="text-sm font-medium">本周暂无入账</p></div>
                                ) : (
                                    currentWeekRecords.map((r, i) => {
                                        const char = characters.find(c => c.id === r.charId) || {name: '未知', school: 'default'};
                                        const schoolStyle = getSchoolStyle(char.school);
                                        return (
                                            <div key={r.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center group hover:shadow-md transition-all animate-fade-in" style={{animationDelay: `${i * 0.05}s`}}>
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1.5"><span className="text-base font-bold text-slate-800">{char.name}</span><span className="text-[10px] px-1.5 py-0.5 rounded font-bold" style={{backgroundColor: schoolStyle.backgroundColor, color: schoolStyle.color}}>{char.school}</span></div>
                                                    <div className="text-xs text-slate-400 font-medium flex items-center gap-1"><span>{r.raidName}</span><span className="w-1 h-1 rounded-full bg-slate-300"></span><span>{r.date.slice(5)}</span></div>
                                                </div>
                                                <div className="text-right"><div className="font-bold text-indigo-600 text-lg font-din">+<MoneyDisplay amount={r.wage} /></div><button onClick={() => handleDeleteRecord(r.id)} className="text-xs text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity font-medium mt-1">撤销</button></div>
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>